<!-- pages/me/profile/profile.wxml -->
<view class="profile-container">
  <!-- ä¸»åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{isLoading}}">
    <view class="loading-content">
      <image src="/images/loading.gif" class="loading-icon"></image>
      <text>åŠ è½½ç”¨æˆ·ä¿¡æ¯...</text>
    </view>
  </view>

  <view wx:else>
    <!-- å¤´éƒ¨ç”¨æˆ·ä¿¡æ¯æ¨¡å— -->
    <view class="header-section card">
      <view class="user-basic-info">
        <!-- å¤´åƒï¼Œæ·»åŠ é”™è¯¯å¤„ç† -->
        <image 
          class="user-avatar" 
          src="{{userInfo.avatar}}" 
          mode="aspectFill"
          binderror="onImageError"
          data-type="avatar">
        </image>
        <view class="user-text-info">
          <view class="user-nickname">{{userInfo.nickname}}</view>
          <view class="user-college">{{userInfo.college || 'æœªè®¾ç½®å­¦é™¢'}}</view>
          <view class="user-stats">
            <text class="stat-item">åŠ å…¥ {{userInfo.joinDays}} å¤©</text>
            <text class="stat-item">ä¿¡ç”¨ {{userInfo.creditScore}}</text>
          </view>
        </view>
      </view>
      
      <!-- æ ¹æ®æ˜¯å¦æŸ¥çœ‹ä»–äººæ˜¾ç¤ºä¸åŒæŒ‰é’® -->
      <button 
        class="action-btn message-btn" 
        bindtap="onSendMessage" 
        wx:if="{{isViewOtherUser}}">
        ç§ä¿¡
      </button>
      <button 
        class="action-btn edit-btn" 
        bindtap="onEditProfile" 
        wx:else>
        ç¼–è¾‘èµ„æ–™
      </button>
    </view>

    <!-- è¯„ä»·æ¨¡å— -->
    <view class="rating-section card" wx:if="{{!isViewOtherUser || commentCount > 0}}">
      <view class="rating-title">ç”¨æˆ·è¯„ä»·</view>
      <view class="rating-content">
        <!-- å·¦è¾¹è¯„è®ºæ»šåŠ¨åŒºåŸŸ -->
        <view class="comment-scroll" wx:if="{{comments.length > 0}}">
          <scroll-view class="comment-list" scroll-y>
            <view class="comment-item" wx:for="{{comments}}" wx:key="id">
              <text class="comment-user">{{item.user}}:</text>
              <text class="comment-text">{{item.content}}</text>
            </view>
          </scroll-view>
        </view>
        <view class="comment-empty" wx:else>
          <text>æš‚æ— è¯„ä»·</text>
        </view>
        <!-- å³è¾¹è¯„åˆ†åŒºåŸŸ -->
        <view class="score-display">
          <view class="score-number">{{ratingScore}}</view>
          <view class="score-total">/5åˆ†</view>
          <view class="rating-stars">
            <!-- æ ¹æ®å®é™…è¯„åˆ†æ˜¾ç¤ºæ˜Ÿæ˜Ÿ -->
            <text class="star active" wx:for="{{5}}" wx:key="*this" wx:if="{{index < Math.floor(ratingScore)}}">â˜…</text>
            <text class="star" wx:for="{{5}}" wx:key="*this" wx:if="{{index >= Math.floor(ratingScore)}}">â˜†</text>
          </view>
          <view class="rating-count">{{commentCount}}æ¡è¯„ä»·</view>
        </view>
      </view>
    </view>

    <!-- ä¸ªäººç®€ä»‹æ¨¡å— -->
    <view class="bio-section card">
      <view class="section-title">ä¸ªäººç®€ä»‹</view>
      <view class="bio-content">{{userInfo.bio || 'æš‚æ— ç®€ä»‹'}}</view>
      <view class="tags-section">
        <view class="tags-title">ä¸ªæ€§æ ‡ç­¾</view>
        <view class="tags-list">
          <text class="tag" wx:for="{{userInfo.tags}}" wx:key="*this">{{item}}</text>
          <text class="tag add-tag" bindtap="onAddTag" wx:if="{{!isViewOtherUser}}">+</text>
        </view>
      </view>
    </view>

    <!-- å‡ºç‰©å’Œè®¸æ„¿ä¿¡æ¯æ¨¡å— -->
    <view class="goods-section">
      <!-- æ ‡ç­¾åˆ‡æ¢ -->
      <view class="goods-tabs">
        <view 
          class="tab {{activeGoodsTab === 'published' ? 'active' : ''}}"
          data-tab="published" 
          bindtap="switchGoodsTab">
          å‘å¸ƒ ({{publishedGoods.length}})
        </view>
        <view 
          class="tab {{activeGoodsTab === 'wish' ? 'active' : ''}}"
          data-tab="wish" 
          bindtap="switchGoodsTab">
          è®¸æ„¿ ({{wishGoods.length}})
        </view>
      </view>

      <!-- å•†å“åˆ—è¡¨åŠ è½½çŠ¶æ€ -->
      <view class="loading-state" wx:if="{{activeGoodsTab === 'published' && isLoadingGoods}}">
        <view class="loading-content">
          <image src="/images/loading.gif" class="loading-icon"></image>
          <text>åŠ è½½å•†å“ä¸­...</text>
        </view>
      </view>

      <!-- æ„¿æœ›åˆ—è¡¨åŠ è½½çŠ¶æ€ -->
      <view class="loading-state" wx:if="{{activeGoodsTab === 'wish' && isLoadingWishes}}">
        <view class="loading-content">
          <image src="/images/loading.gif" class="loading-icon"></image>
          <text>åŠ è½½æ„¿æœ›ä¸­...</text>
        </view>
      </view>

      <!-- å•†å“/æ„¿æœ›åˆ—è¡¨å†…å®¹ -->
      <view class="goods-list" wx:if="{{!isLoadingGoods && !isLoadingWishes}}">
        <!-- å·²å‘å¸ƒå•†å“ -->
        <block wx:if="{{activeGoodsTab === 'published'}}">
          <!-- ç©ºçŠ¶æ€ -->
          <view class="empty-state" wx:if="{{showEmptyGoods || publishedGoods.length === 0}}">
            <image src="/images/empty-goods.png" class="empty-icon"></image>
            <text class="empty-text">è¿˜æ²¡æœ‰å‘å¸ƒå•†å“å“¦ï½</text>
          </view>
          
          <!-- å•†å“åˆ—è¡¨ -->
          <view 
            class="goods-item" 
            wx:for="{{publishedGoods}}" 
            wx:key="id" 
            data-id="{{item.id}}" 
            data-index="{{index}}"
            bindtap="onGoodsTap">
            <image 
              class="goods-image" 
              src="{{item.image}}" 
              mode="aspectFill" 
              data-index="{{index}}" 
              binderror="onImageError"
              data-type="goods">
            </image>
            <view class="goods-info">
              <view class="goods-title">{{item.title}}</view>
              <view class="goods-price">
                <text class="price" wx:if="{{item.price > 0}}">Â¥{{item.price}}</text>
                <text class="swap-tag" wx:if="{{item.transactionType === 'swap'}}">å¯æ¢ç‰©</text>
                <text class="both-tag" wx:if="{{item.transactionType === 'both'}}">å¯ä¹°å¯æ¢</text>
                <text class="status-tag {{item.status}}" wx:if="{{item.status !== 'selling'}}">{{item.status === 'sold' ? 'å·²å”®å‡º' : 'å·²ä¸‹æ¶'}}</text>
              </view>
              <view class="goods-desc">{{item.description}}</view>
            </view>
          </view>
        </block>

        <!-- è®¸æ„¿åˆ—è¡¨ -->
        <block wx:if="{{activeGoodsTab === 'wish'}}">
          <!-- ç©ºçŠ¶æ€ -->
          <view class="empty-state" wx:if="{{showEmptyWishes || wishGoods.length === 0}}">
            <image src="/images/empty-wish.png" class="empty-icon"></image>
            <text class="empty-text">è¿˜æ²¡æœ‰è®¸æ„¿å“¦ï½</text>
          </view>
          
          <!-- æ„¿æœ›åˆ—è¡¨ -->
          <view 
            class="wish-item" 
            wx:for="{{wishGoods}}" 
            wx:key="_id" 
            data-id="{{item._id}}"
            data-index="{{index}}"
            bindtap="onWishTap">
            <view class="wish-icon">ğŸ¯</view>
            <view class="wish-info">
              <view class="wish-title">{{item.title || 'æœªå‘½åæ„¿æœ›'}}</view>
              <view class="wish-desc">{{item.description || 'æš‚æ— æè¿°'}}</view>
              <view class="wish-offer">
                <text wx:if="{{item.maxPrice > 0}}">æ„¿ä»˜ Â¥{{item.maxPrice}}</text>
                <text wx:if="{{item.expectedItem}}">æ„¿æ¢ {{item.expectedItem}}</text>
                <text wx:if="{{item.maxPrice <= 0 && !item.expectedItem}}">æ¥å—å•†è®®</text>
              </view>
            </view>
          </view>
        </block>
      </view>
    </view>
  </view>
</view>