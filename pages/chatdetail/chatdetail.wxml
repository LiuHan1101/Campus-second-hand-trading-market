<!-- pages/chatdetail/chatdetail.wxml -->
<view class="chat-container">

  <!-- 消息容器 -->
  <scroll-view 
    class="messages-container" 
    scroll-y 
    scroll-top="{{scrollTop}}"
    scroll-with-animation
    enable-back-to-top
  >
    <!-- 加载提示 -->
    <view wx:if="{{isLoading}}" class="loading-container">
      <view class="loading-text">加载历史消息中...</view>
    </view>

    <!-- 消息列表 -->
    <view class="messages-list">
      <view wx:for="{{messages}}" wx:key="id">
        <!-- 居中时间分隔 -->
        <view wx:if="{{item.type === 'time-separator'}}" class="time-separator">{{item.text}}</view>
        
        <!-- 普通消息 -->
        <view wx:else class="message-item {{item.sender === 'sent' ? 'message-sent' : 'message-received'}}">
        <!-- 对方头像 -->
        <image 
          wx:if="{{item.sender === 'received'}}" 
          class="message-avatar" 
          src="{{item.avatar || '/images/avatar.png'}}" 
          mode="aspectFill"
        />
        
        <!-- 消息内容 -->
        <view class="message-content-wrapper">
          <!-- 气泡消息 -->
          <view 
            wx:if="{{!item.isBubble}}" 
            class="message-bubble {{item.sender === 'sent' ? 'sent-bubble' : 'received-bubble'}}"
          >
            <text class="message-text">{{item.text}}</text>
          </view>
          
          <!-- 确认收货气泡 -->
          <view 
            wx:if="{{item.isBubble && item.bubbleType === 'confirm'}}" 
            class="confirm-bubble"
          >
            <view class="confirm-title">{{item.text}}</view>
            <view class="confirm-buttons">
              <button class="confirm-btn confirm" bindtap="onConfirmReceipt">确认收货</button>
              <button class="confirm-btn cancel" bindtap="cancelConfirm">取消</button>
            </view>
          </view>
          
          <!-- 评价气泡 -->
          <view 
            wx:if="{{item.isBubble && item.bubbleType === 'rating'}}" 
            class="rating-bubble"
          >
            <view class="rating-title">{{item.text}}</view>
            
            <!-- 描述相符评分 -->
            <view class="rating-item">
              <view class="rating-label">描述相符</view>
              <view class="rating-stars">
                <view 
                  wx:for="{{[1,2,3,4,5]}}" 
                  wx:key="index"
                  class="star {{ratingData.descScore >= item ? 'star-active' : ''}}"
                  data-score="{{item}}"
                  bindtap="rateDesc"
                >★</view>
              </view>
            </view>
            
            <!-- 发货速度评分 -->
            <view class="rating-item">
              <view class="rating-label">发货速度</view>
              <view class="rating-stars">
                <view 
                  wx:for="{{[1,2,3,4,5]}}" 
                  wx:key="index"
                  class="star {{ratingData.timeScore >= item ? 'star-active' : ''}}"
                  data-score="{{item}}"
                  bindtap="rateTime"
                >★</view>
              </view>
            </view>
            
            <!-- 服务态度评分 -->
            <view class="rating-item">
              <view class="rating-label">服务态度</view>
              <view class="rating-stars">
                <view 
                  wx:for="{{[1,2,3,4,5]}}" 
                  wx:key="index"
                  class="star {{ratingData.attitudeScore >= item ? 'star-active' : ''}}"
                  data-score="{{item}}"
                  bindtap="rateAttitude"
                >★</view>
              </view>
            </view>
            
            <!-- 评价内容 -->
            <view class="rating-comment">
              <textarea 
                class="comment-input" 
                placeholder="请输入评价内容（选填）"
                maxlength="200"
                value="{{comment}}"
                bindinput="onCommentInput"
              />
              <view class="comment-tip">{{comment.length}}/200</view>
            </view>
            
            <!-- 评价按钮 -->
            <view class="rating-buttons">
              <button class="rating-btn submit" bindtap="submitRating">提交评价</button>
              <button class="rating-btn cancel" bindtap="cancelRating">取消</button>
            </view>
          </view>
        </view>
        
        <!-- 自己头像 -->
        <image 
          wx:if="{{item.sender === 'sent'}}" 
          class="message-avatar" 
          src="{{item.avatar || '/images/avatar.png'}}" 
          mode="aspectFill"
        />
        
        <!-- 消息时间（仅在未使用居中分隔且需要显示时） -->
        <view wx:if="{{item.showTime}}" class="message-time">{{item.time}}</view>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- 输入区域 -->
  <view class="input-area" style="padding-bottom: {{safeAreaBottom}}px">
    <view class="input-wrapper">
      <textarea
        class="message-input"
        placeholder="输入消息..."
        placeholder-class="input-placeholder"
        value="{{inputValue}}"
        bindinput="onInput"
        bindlinechange="onInputLineChange"
        maxlength="500"
        cursor-spacing="10"
        adjust-position="{{true}}"
        style="height: {{inputHeight}}px"
      />
      <button 
        class="send-btn {{canSend ? 'send-btn-active' : ''}}" 
        bindtap="sendMessage"
        disabled="{{!canSend}}"
      >
        <text class="send-text">发送</text>
      </button>
    </view>
  </view>

  <!-- 测试按钮（开发阶段使用） -->
  <!-- <view class="test-buttons" wx:if="{{false}}">
    <button class="test-btn" bindtap="testSellerBubble">模拟卖家触发确认收货</button>
  </view> -->
</view>